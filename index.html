<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coin Researcher</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 600px;
            width: 100%;
            padding: 40px;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .help-button {
            background: #667eea;
            color: white;
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .help-button:hover {
            background: #5568d3;
            transform: scale(1.1);
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .external-search-banner {
            background: #f5f5f5;
            padding: 12px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 14px;
            color: #666;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-wrap: nowrap;
            gap: 8px;
        }

        .external-link {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            margin: 0 8px;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            text-decoration: none;
            color: #333;
            font-weight: 500;
            transition: all 0.3s;
        }

        .external-link:hover {
            background: #e8e8e8;
            border-color: #667eea;
            transform: translateY(-1px);
        }

        .external-link img {
            width: 20px;
            height: 20px;
        }

        /* íƒ­ ìŠ¤íƒ€ì¼ */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #e0e0e0;
        }

        .tab {
            flex: 1;
            padding: 12px 20px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            color: #888;
            transition: all 0.3s;
        }

        .tab:hover {
            color: #667eea;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .input-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            color: #555;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 14px;
        }

        input, select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        /* ë¼ë””ì˜¤ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .radio-group {
            display: flex;
            gap: 20px;
            margin-top: 8px;
        }

        .radio-option {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .radio-option input[type="radio"] {
            width: auto;
            cursor: pointer;
        }

        .radio-option label {
            margin: 0;
            cursor: pointer;
            font-weight: 500;
        }

        .coin-options {
            margin-top: 10px;
            display: none;
            max-height: 340px;
            overflow-y: auto;
        }

        .coin-options::-webkit-scrollbar {
            width: 8px;
        }

        .coin-options::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .coin-options::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 10px;
        }

        .coin-options::-webkit-scrollbar-thumb:hover {
            background: #5568d3;
        }

        .coin-option {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
        }

        .coin-option:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .coin-option.selected {
            border-color: #667eea;
            background: #f0f3ff;
        }

        .coin-name {
            font-weight: 600;
            color: #333;
            font-size: 15px;
        }

        .coin-ticker {
            color: #667eea;
            font-weight: 700;
        }

        .coin-market-cap {
            color: #888;
            font-size: 13px;
            margin-top: 4px;
        }

        .coin-price {
            color: #667eea;
            font-weight: 600;
            font-size: 14px;
        }

        .coin-volume {
            color: #888;
            font-size: 12px;
            margin-top: 2px;
        }

        .cache-info {
            font-size: 11px;
            color: #999;
            margin-top: 6px;
            font-weight: 400;
        }

        .source-section {
            margin-bottom: 20px;
        }

        .source-label {
            display: block;
            color: #555;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .source-option {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: #333;
        }

        .source-option input[type="radio"] {
            width: auto;
            cursor: default;
        }

        .source-option label {
            margin: 0;
            font-weight: 500;
            cursor: default;
        }

        .result-source {
            font-size: 12px;
            color: rgba(255,255,255,0.8);
            margin-top: 4px;
        }

        .rank-badge {
            display: inline-block;
            background: #ffd700;
            color: #333;
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 12px;
            font-weight: 700;
            margin-left: 8px;
        }

        .loading {
            text-align: center;
            color: #667eea;
            padding: 10px;
            font-size: 14px;
        }

        .error {
            color: #e74c3c;
            font-size: 14px;
            margin-top: 8px;
            white-space: pre-line;
        }

        .error-link {
            display: inline-block;
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
            margin-top: 8px;
            padding: 8px 16px;
            border: 2px solid #667eea;
            border-radius: 8px;
            transition: all 0.3s;
            font-size: 13px;
        }

        .error-link:hover {
            background: #667eea;
            color: white;
            transform: translateY(-1px);
        }

        .result {
            margin-top: 30px;
            padding: 25px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            color: white;
            display: none;
        }

        .result-item {
            margin-bottom: 20px;
        }

        .result-label {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .result-value {
            font-size: 36px;
            font-weight: 700;
            line-height: 1.2;
        }

        .result-date {
            font-size: 13px;
            opacity: 0.9;
            margin-bottom: 15px;
            font-weight: 500;
        }

        .divider {
            height: 2px;
            background: rgba(255,255,255,0.4);
            margin: 20px 0;
        }

        .result-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
            opacity: 0.9;
            gap: 15px;
            flex-wrap: wrap;
        }

        .result-footer-item {
            flex: 1;
            min-width: 150px;
        }

        .link-btn {
            display: inline-block;
            background: white;
            color: #667eea;
            padding: 12px 24px;
            border-radius: 10px;
            text-decoration: none;
            font-weight: 600;
            margin-top: 15px;
            transition: transform 0.2s;
            font-size: 15px;
        }

        .link-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .info-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid rgba(255,255,255,0.4);
        }

        .info-section-title {
            font-size: 15px;
            font-weight: 700;
            margin-bottom: 10px;
            opacity: 0.95;
        }

        .info-item {
            font-size: 14px;
            line-height: 1.6;
            margin-bottom: 4px;
            opacity: 0.9;
        }

        .info-warning {
            font-size: 12px;
            opacity: 0.8;
            margin-top: 8px;
        }


        @media (max-width: 640px) {
            .container {
                padding: 25px;
            }

            h1 {
                font-size: 24px;
            }

            .result-value {
                font-size: 28px;
            }

            .result-footer {
                flex-direction: column;
                align-items: flex-start;
            }

            .result-footer-item {
                width: 100%;
            }
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 8px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            animation: fadeIn 0.3s;
        }

        .modal-overlay.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            animation: slideIn 0.3s;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 700;
            color: #333;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 28px;
            color: #999;
            cursor: pointer;
            transition: color 0.3s;
        }

        .modal-close:hover {
            color: #333;
        }

        .modal-content {
            color: #555;
            line-height: 1.8;
        }

        .modal-content h3 {
            color: #667eea;
            margin-top: 20px;
            margin-bottom: 10px;
            font-size: 18px;
        }

        .modal-content ul {
            margin-left: 20px;
            margin-bottom: 15px;
        }

        .modal-content li {
            margin-bottom: 8px;
        }

        .modal-links {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .modal-link {
            display: inline-block;
            padding: 8px 16px;
            background: #667eea;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .modal-link:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* ì´ìŠ¤í„°ì—ê·¸ ìŠ¤íƒ€ì¼ */
        .easter-egg {
            border: 3px solid #ffd700;
            background: linear-gradient(135deg, #fff9e6 0%, #ffe5e5 100%);
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            margin-top: 20px;
            animation: fadeIn 0.5s, rainbow 3s infinite;
            box-shadow: 0 10px 40px rgba(255, 215, 0, 0.3);
        }

        .easter-egg-title {
            font-size: 28px;
            color: #ff6b6b;
            margin-bottom: 20px;
            font-weight: 700;
        }

        .easter-egg-content {
            color: #333;
            line-height: 2;
            font-size: 16px;
        }

        .easter-egg-value {
            font-size: 32px;
            font-weight: 700;
            color: #667eea;
            margin: 20px 0;
        }

        .easter-egg-links {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .easter-egg-link {
            display: inline-block;
            padding: 12px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-decoration: none;
            border-radius: 10px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .easter-egg-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        @keyframes rainbow {
            0% { box-shadow: 0 10px 40px rgba(255, 0, 0, 0.2); }
            16% { box-shadow: 0 10px 40px rgba(255, 127, 0, 0.2); }
            33% { box-shadow: 0 10px 40px rgba(255, 255, 0, 0.2); }
            50% { box-shadow: 0 10px 40px rgba(0, 255, 0, 0.2); }
            66% { box-shadow: 0 10px 40px rgba(0, 0, 255, 0.2); }
            83% { box-shadow: 0 10px 40px rgba(75, 0, 130, 0.2); }
            100% { box-shadow: 0 10px 40px rgba(148, 0, 211, 0.2); }
        }

        /* ëª¨ë°”ì¼ ë°˜ì‘í˜• */
        @media (max-width: 768px) {
            .container {
                width: 90%;
                padding: 20px;
                margin: 10px auto;
            }

            h1 {
                font-size: 22px;
            }

            .help-button {
                width: 32px;
                height: 32px;
                font-size: 18px;
            }

            .external-search-banner {
                font-size: 12px;
                padding: 10px;
                flex-wrap: wrap;
            }

            .external-link {
                padding: 4px 8px;
                margin: 4px;
                font-size: 12px;
            }

            .external-link img {
                width: 16px;
                height: 16px;
            }

            input, select {
                min-height: 48px;
                font-size: 16px;
            }

            .tab {
                min-height: 44px;
                font-size: 14px;
                padding: 10px 16px;
            }

            .coin-option {
                min-height: 60px;
                padding: 12px;
            }

            .result-value {
                font-size: 28px;
            }

            .link-btn, .error-link {
                width: 100%;
                text-align: center;
            }

            .modal {
                width: 95%;
                padding: 20px;
            }

            .modal-title {
                font-size: 20px;
            }

            .easter-egg {
                padding: 20px;
            }

            .easter-egg-title {
                font-size: 22px;
            }

            .easter-egg-value {
                font-size: 24px;
            }

            .easter-egg-links {
                flex-direction: column;
            }

            .easter-egg-link {
                width: 100%;
            }
        }

        /* í„°ì¹˜ ìµœì í™” */
        @media (hover: none) and (pointer: coarse) {
            .coin-option, .tab, button, a {
                -webkit-tap-highlight-color: rgba(102, 126, 234, 0.2);
            }
        }

        /* ìŠ¤í¬ë¡¤ ë¶€ë“œëŸ½ê²Œ (ëª¨ë°”ì¼) */
        .modal, .coin-options, .result {
            -webkit-overflow-scrolling: touch;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>
            ğŸ” Coin Researcher
            <button class="help-button" onclick="openHelpModal()">?</button>
        </h1>
        <p class="subtitle">OTC ë”œì„ ìœ„í•œ ì½”ì¸ ë¶„ì„ ë„êµ¬</p>

        <!-- ì™¸ë¶€ ê²€ìƒ‰ ë°°ë„ˆ -->
        <div class="external-search-banner">
            ğŸŒ ì™¸ë¶€ ê²€ìƒ‰:
            <a href="https://coinmarketcap.com/" target="_blank" class="external-link" title="CoinMarketCapì—ì„œ ì½”ì¸ ê²€ìƒ‰">
                <img src="https://www.google.com/s2/favicons?domain=coinmarketcap.com&sz=32" alt="CMC">
                CoinMarketCap
            </a>
            <a href="https://www.coingecko.com/" target="_blank" class="external-link" title="CoinGeckoì—ì„œ ì½”ì¸ ê²€ìƒ‰">
                <img src="https://www.google.com/s2/favicons?domain=coingecko.com&sz=32" alt="CoinGecko">
                CoinGecko
            </a>
            <a href="https://www.deribit.com/" target="_blank" class="external-link" title="Deribitì—ì„œ ì½”ì¸ ê²€ìƒ‰">
                <img src="https://www.google.com/s2/favicons?domain=deribit.com&sz=32" alt="Deribit">
                Deribit
            </a>
        </div>

        <!-- íƒ­ -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('realtime')">ì‹¤ì‹œê°„</button>
            <button class="tab" onclick="switchTab('historical')">ê³¼ê±° ì¡°íšŒ</button>
        </div>

        <!-- ì‹¤ì‹œê°„ íƒ­ -->
        <div id="realtime" class="tab-content active">
            <div class="input-group">
                <label>ê¸°ì¤€</label>
                <div class="radio-group" id="realtimeSourceOptions">
                    <!-- JavaScriptë¡œ ë™ì  ìƒì„± -->
                </div>
            </div>

            <div class="input-group">
                <label for="ticker">ì½”ì¸ í‹°ì»¤ or ì´ë¦„</label>
                <input type="text" id="ticker" placeholder="ì˜ˆ: BTC, ETH, SOL" autocomplete="off">
                <div id="loading" class="loading" style="display: none;">
                    <div class="spinner"></div>ì½”ì¸ ê²€ìƒ‰ ì¤‘...
                </div>
                <div id="error" class="error"></div>
                <div id="cacheInfo" class="cache-info" style="display: none;"></div>
                <div id="coinOptions" class="coin-options"></div>
            </div>

            <div class="input-group">
                <label for="amount">ìˆ˜ëŸ‰</label>
                <input type="text" id="amount" placeholder="ê±°ë˜ ìˆ˜ëŸ‰ ì…ë ¥">
            </div>

            <div id="result" class="result">
                <div class="result-item">
                    <div class="result-label">USDT ì´ì•¡</div>
                    <div class="result-value" id="usdtTotal">$0.00</div>
                </div>

                <div class="result-item">
                    <div class="result-label">KRW ì´ì•¡</div>
                    <div class="result-value" id="krwTotal">â‚©0</div>
                </div>

                <div class="divider"></div>

                <div class="result-footer-item">
                    <div id="coinPrice"></div>
                    <div class="result-source" id="coinPriceSource">* ê¸°ì¤€: CoinGecko</div>
                </div>

                <div style="margin-top: 15px;">
                    <div id="exchangeRate"></div>
                    <div class="result-source">* ê¸°ì¤€: ì—…ë¹„íŠ¸</div>
                </div>

                <div id="chainInfo" class="info-section" style="display: none;">
                    <div class="info-section-title">ğŸ“¡ ì§€ì› ì²´ì¸</div>
                    <div id="chainList"></div>
                </div>

                <div id="exchangeInfo" class="info-section" style="display: none;">
                    <div class="info-section-title">ğŸ¦ ê±°ë˜ ê°€ëŠ¥</div>
                    <div id="exchangeList"></div>
                </div>

                <div id="walletInfo" class="info-section" style="display: none;">
                    <div class="info-section-title">ğŸ’¼ ì§€ê°‘ í˜¸í™˜ì„± (ì°¸ê³ ìš© - 2026.01 ê¸°ì¤€)</div>
                    <div id="walletList"></div>
                    <div class="info-warning">âš ï¸ ì‹¤ì œ ê±°ë˜ ì „ ì§€ê°‘ì—ì„œ ì¬í™•ì¸ í•„ìˆ˜</div>
                </div>

                <a id="coingeckoLink" href="#" target="_blank" class="link-btn" style="display: none;">
                    ğŸ”— CoinGeckoì—ì„œ í™•ì¸í•˜ê¸°
                </a>
            </div>

            <!-- ì´ìŠ¤í„°ì—ê·¸ -->
            <div id="easterEgg" class="easter-egg" style="display: none;">
                <div class="easter-egg-title">ğŸ‰ ì´ìŠ¤í„°ì—ê·¸ ë°œê²¬! ğŸ‰</div>
                <div class="easter-egg-content">
                    ğŸ’Œ ì œì‘ì <strong>Patrick Lee</strong>ì…ë‹ˆë‹¤<br>
                    ìƒì¼: <strong>1994ë…„ 10ì›” 4ì¼</strong><br><br>
                    ì´ ê³„ì‚°ê¸°ëŠ” ì œ ì²« ë°”ì´ë¸Œì½”ë”© í”„ë¡œì íŠ¸ì…ë‹ˆë‹¤.<br>
                    ì‚¬ìš©í•´ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤! ğŸ™<br><br>
                    <strong>íŠ¹ë³„ ê³„ì‚° ê²°ê³¼:</strong>
                    <div class="easter-egg-value">
                        Patrick Lee ì½”ì¸ = $1,994<br>
                        ì´ ë³´ìœ ì•¡ = $19,940,407,976<br>
                        <span style="font-size: 20px;">(ì•½ 200ì–µ ì›!)</span>
                    </div>
                </div>
                <div class="easter-egg-links">
                    <a href="https://www.youtube.com/watch?v=DTXaHsIPjnY" target="_blank" class="easter-egg-link">ğŸ‚ ìƒì¼ ì¶•í•˜ ë…¸ë˜ ë“£ê¸°</a>
                </div>
            </div>
        </div>

        <!-- ê³¼ê±° ì¡°íšŒ íƒ­ -->
        <div id="historical" class="tab-content">
            <div class="input-group">
                <label>ê¸°ì¤€</label>
                <div class="radio-group" id="historicalSourceOptions">
                    <!-- JavaScriptë¡œ ë™ì  ìƒì„± -->
                </div>
            </div>

            <div class="input-group">
                <label for="histDate">ì¡°íšŒ ë‚ ì§œ</label>
                <input type="date" id="histDate">
            </div>

            <div class="input-group">
                <label for="histTicker" id="histTickerLabel">ì½”ì¸ í‹°ì»¤</label>
                <input type="text" id="histTicker" placeholder="ì˜ˆ: BTC, ETH, SOL">
                <select id="histCoinSelect" style="display: none;">
                    <option value="BTC">BTC</option>
                    <option value="ETH">ETH</option>
                    <option value="SOL">SOL</option>
                </select>
                <div id="histLoading" class="loading" style="display: none;">
                    <div class="spinner"></div>ì½”ì¸ ê²€ìƒ‰ ì¤‘...
                </div>
                <div id="histError" class="error"></div>
                <div id="histCoinOptions" class="coin-options"></div>
            </div>

            <div class="input-group">
                <label for="histAmount">ìˆ˜ëŸ‰</label>
                <input type="text" id="histAmount" value="1" onfocus="if(this.value=='1') this.value=''">
            </div>

            <div id="histResult" class="result">
                <div class="result-date" id="histResultDate"></div>

                <div class="result-item">
                    <div class="result-label" id="histUsdLabel">USDT ì´ì•¡</div>
                    <div class="result-value" id="histUsdtTotal">$0.00</div>
                </div>

                <div class="result-item">
                    <div class="result-label">KRW ì´ì•¡</div>
                    <div class="result-value" id="histKrwTotal">â‚©0</div>
                </div>

                <div class="divider"></div>

                <div class="result-footer-item">
                    <div id="histCoinPrice"></div>
                    <div class="result-source" id="histCoinPriceSource">* ê¸°ì¤€: CoinGecko</div>
                </div>

                <div style="margin-top: 15px;">
                    <div id="histExchangeRate"></div>
                    <div class="result-source">* ê¸°ì¤€: ì—…ë¹„íŠ¸</div>
                </div>

                <a id="histLink" href="#" target="_blank" class="link-btn" style="display: none;">
                    ğŸ”— ìƒì„¸ ì •ë³´ í™•ì¸í•˜ê¸°
                </a>
            </div>
        </div>

    </div>

    <!-- ë„ì›€ë§ ëª¨ë‹¬ -->
    <div id="helpModal" class="modal-overlay" onclick="closeHelpModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <div class="modal-title">â“ ì‚¬ìš© ë°©ë²•</div>
                <button class="modal-close" onclick="closeHelpModal()">&times;</button>
            </div>
            <div class="modal-content">
                <h3>ğŸ“Œ ì´ ê³„ì‚°ê¸°ëŠ”?</h3>
                <p>ì•ŒíŠ¸ì½”ì¸ì˜ USDT ë° KRW ì´ì•¡ì„ ë¹ ë¥´ê²Œ ê³„ì‚°í•´ì£¼ëŠ” ë„êµ¬ì…ë‹ˆë‹¤.</p>

                <h3>ğŸ“ ì‚¬ìš© ë°©ë²•</h3>
                <ul>
                    <li><strong>1ï¸âƒ£ ì¡°íšŒ ì‹œì  ì„ íƒ</strong>
                        <ul>
                            <li>ì‹¤ì‹œê°„: í˜„ì¬ ì‹œì„¸</li>
                            <li>ê³¼ê±°: íŠ¹ì • ë‚ ì§œ ì‹œì„¸</li>
                        </ul>
                    </li>
                    <li><strong>2ï¸âƒ£ ë°ì´í„° ì†ŒìŠ¤ ì„ íƒ (ì„ íƒì‚¬í•­)</strong>
                        <ul>
                            <li>CoinGecko (ê¸°ë³¸)</li>
                            <li>Deribit Index (ê³¼ê±°ë§Œ, ì¤€ë¹„ì¤‘)</li>
                        </ul>
                    </li>
                    <li><strong>3ï¸âƒ£ ì½”ì¸ ê²€ìƒ‰</strong>
                        <ul>
                            <li>í‹°ì»¤ ì…ë ¥: BTC, ETH, SOL</li>
                            <li>ì´ë¦„ ì…ë ¥: Bitcoin, Ethereum</li>
                            <li>ê²€ìƒ‰ ê²°ê³¼ì—ì„œ ì„ íƒ</li>
                        </ul>
                    </li>
                    <li><strong>4ï¸âƒ£ ìˆ˜ëŸ‰ ì…ë ¥</strong>
                        <ul>
                            <li>ë³´ìœ /ê±°ë˜í•  ì½”ì¸ ê°œìˆ˜ ì…ë ¥</li>
                        </ul>
                    </li>
                    <li><strong>5ï¸âƒ£ ê²°ê³¼ í™•ì¸</strong>
                        <ul>
                            <li>USDT ì´ì•¡</li>
                            <li>KRW ì´ì•¡ (ì—…ë¹„íŠ¸ í™˜ìœ¨)</li>
                        </ul>
                    </li>
                </ul>

                <h3>ğŸ’¡ íŒ</h3>
                <ul>
                    <li>ì²œ ë‹¨ìœ„ êµ¬ë¶„: 1,000 ìë™ í‘œì‹œ</li>
                    <li>ìŠ¤í¬ë¡¤: ê²€ìƒ‰ ê²°ê³¼ ë”ë³´ê¸°</li>
                </ul>

                <h3>ğŸ“Š ë°ì´í„° ì¶œì²˜</h3>
                <ul>
                    <li>ì½”ì¸ ì‹œì„¸: CoinGecko API</li>
                    <li>USDT/KRW: ì—…ë¹„íŠ¸ API</li>
                </ul>

                <h3>âš ï¸ ì£¼ì˜ì‚¬í•­</h3>
                <ul>
                    <li>ë³¸ ê³„ì‚°ê¸°ëŠ” ì°¸ê³ ìš© ê³„ì‚°ê¸°ì…ë‹ˆë‹¤</li>
                    <li>ë¬´ë£Œ APIë¥¼ ì‚¬ìš©í•˜ê¸° ë•Œë¬¸ì— ê²€ìƒ‰ ì œí•œì— ë”°ë¥¸ ì˜¤ë¥˜ê°€ ë¹ˆë²ˆíˆ ë°œìƒí•©ë‹ˆë‹¤.</li>
                </ul>

                <h3>ğŸ‘¨â€ğŸ’» ì œì‘ì</h3>
                <p><strong>Patrick Lee</strong> (1994.10.04)</p>
            </div>
        </div>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        let selectedCoin = null;
        let usdtKrwRate = 0;
        let debounceTimer = null;
        let histSelectedCoin = null;
        let histDebounceTimer = null;

        // API ìºì‹± (10ë¶„)
        const searchCache = {};
        const CACHE_DURATION = 10 * 60 * 1000; // 600,000ms = 10ë¶„

        // ë°ì´í„° ì†ŒìŠ¤ ì„¤ì • (ì‹¤ì‹œê°„ ë° ê³¼ê±° ê³µí†µ)
        const dataSources = [
            { id: 'auto', name: 'Auto (Fallback)', enabled: true, selected: true },
            { id: 'coinmarketcap', name: 'CoinMarketCap', enabled: true, selected: false },
            { id: 'coingecko', name: 'CoinGecko', enabled: true, selected: false },
            { id: 'deribit', name: 'Deribit', enabled: false, selected: false }
        ];

        // í˜„ì¬ ì„ íƒëœ ë°ì´í„° ì†ŒìŠ¤ ì¶”ì 
        let currentRealtimeSource = 'auto';
        let currentHistoricalSource = 'auto';
        let lastUsedSource = null; // Auto ëª¨ë“œì—ì„œ ì‹¤ì œ ì‚¬ìš©ëœ ì†ŒìŠ¤ ì¶”ì 

        // í‹°ì»¤ ì´ë¦„ ë³€ê²½ ë§¤í•‘
        const renamedTickers = {
            'XPLA': { apiId: 'xpla', newName: 'CONX', oldName: 'XPLA' }
        };

        // ë©”ì´ì € ì½”ì¸ (ìì²´ ë¸”ë¡ì²´ì¸) - íŠ¹ìˆ˜ ì²˜ë¦¬
        const majorNativeCoins = {
            'bitcoin': { chain: 'bitcoin', name: 'Bitcoin', icon: 'https://cryptologos.cc/logos/bitcoin-btc-logo.svg' },
            'ethereum': { chain: 'ethereum', name: 'Ethereum', icon: 'https://cryptologos.cc/logos/ethereum-eth-logo.svg' },
            'solana': { chain: 'solana', name: 'Solana', icon: 'https://cryptologos.cc/logos/solana-sol-logo.svg' },
            'binancecoin': { chain: 'binance-smart-chain', name: 'BNB Chain', icon: 'https://cryptologos.cc/logos/bnb-bnb-logo.svg' },
            'cardano': { chain: 'cardano', name: 'Cardano', icon: 'https://cryptologos.cc/logos/cardano-ada-logo.svg' },
            'avalanche-2': { chain: 'avalanche', name: 'Avalanche', icon: 'https://cryptologos.cc/logos/avalanche-avax-logo.svg' },
            'polkadot': { chain: 'polkadot', name: 'Polkadot', icon: 'https://cryptologos.cc/logos/polkadot-new-dot-logo.svg' },
            'cosmos': { chain: 'cosmos', name: 'Cosmos', icon: 'https://cryptologos.cc/logos/cosmos-atom-logo.svg' },
            'stellar': { chain: 'stellar', name: 'Stellar', icon: 'https://cryptologos.cc/logos/stellar-xlm-logo.svg' },
            'tron': { chain: 'tron', name: 'TRON', icon: 'https://cryptologos.cc/logos/tron-trx-logo.svg' }
        };

        // ë„¤íŠ¸ì›Œí¬ ì•„ì´ì½˜ ë§¤í•‘
        const networkIcons = {
            'ethereum': 'https://cryptologos.cc/logos/ethereum-eth-logo.svg',
            'bitcoin': 'https://cryptologos.cc/logos/bitcoin-btc-logo.svg',
            'binance-smart-chain': 'https://cryptologos.cc/logos/bnb-bnb-logo.svg',
            'polygon-pos': 'https://cryptologos.cc/logos/polygon-matic-logo.svg',
            'arbitrum-one': 'https://cryptologos.cc/logos/arbitrum-arb-logo.svg',
            'optimistic-ethereum': 'https://cryptologos.cc/logos/optimism-ethereum-op-logo.svg',
            'base': 'https://cryptologos.cc/logos/base-logo.svg',
            'avalanche': 'https://cryptologos.cc/logos/avalanche-avax-logo.svg',
            'solana': 'https://cryptologos.cc/logos/solana-sol-logo.svg'
        };

        // ë©”ì´ì € ë„¤ì´í‹°ë¸Œ ì½”ì¸ ì²´ì¸ ë§¤í•‘ (wallet ìš©)
        const majorNativeCoinsMap = {
            'bitcoin': 'bitcoin',
            'ethereum': 'ethereum',
            'solana': 'solana',
            'binancecoin': 'binance-smart-chain',
            'cardano': 'cardano',
            'polkadot': 'polkadot',
            'avalanche-2': 'avalanche',
            'cosmos': 'cosmos',
            'stellar': 'stellar',
            'tron': 'tron'
        };

        // ì§€ê°‘ ì§€ì› ì²´ì¸ ë¦¬ìŠ¤íŠ¸
        const walletSupport = {
            fireblocks: ['ethereum', 'bitcoin', 'binance-smart-chain', 'polygon-pos', 'arbitrum-one', 'optimistic-ethereum', 'avalanche', 'solana', 'polkadot', 'cardano', 'stellar', 'tron', 'cosmos'],
            mpcVault: ['ethereum', 'bitcoin', 'binance-smart-chain', 'polygon-pos', 'arbitrum-one', 'optimistic-ethereum', 'solana', 'avalanche']
        };

        // ë©”ì´ì € ë„¤íŠ¸ì›Œí¬ ë¦¬ìŠ¤íŠ¸
        const majorNetworks = ['binance-smart-chain', 'polygon-pos', 'arbitrum-one', 'optimistic-ethereum', 'base', 'avalanche', 'solana'];

        // ì²´ì¸ëª… ë³€í™˜ ë§¤í•‘
        const chainNameMap = {
            'binance-smart-chain': 'BNB Chain',
            'polygon-pos': 'Polygon',
            'arbitrum-one': 'Arbitrum',
            'optimistic-ethereum': 'Optimism',
            'base': 'Base',
            'avalanche': 'Avalanche',
            'solana': 'Solana',
            'ethereum': 'Ethereum'
        };

        // ë©”ì´ì € CEX ë¦¬ìŠ¤íŠ¸
        const majorExchanges = ['binance', 'upbit', 'bithumb', 'coinbase', 'kraken', 'okx', 'bybit', 'gate', 'korbit', 'huobi', 'kucoin'];
        const koreanExchanges = ['upbit', 'bithumb', 'korbit'];

        // ê±°ë˜ì†Œëª… ë³€í™˜ ë§¤í•‘
        const exchangeNameMap = {
            'binance': 'ë°”ì´ë‚¸ìŠ¤',
            'upbit': 'ì—…ë¹„íŠ¸',
            'bithumb': 'ë¹—ì¸',
            'coinbase': 'Coinbase',
            'kraken': 'Kraken',
            'okx': 'OKX',
            'bybit': 'Bybit',
            'gate': 'Gate.io',
            'korbit': 'ì½”ë¹—',
            'huobi': 'Huobi',
            'kucoin': 'KuCoin'
        };

        // ì˜¤ë¥˜ ë©”ì‹œì§€ í‘œì‹œ í—¬í¼ í•¨ìˆ˜
        function showError(errorElement, title, message, linkText = null, linkUrl = null) {
            let errorHTML = `<strong>${title}</strong>\n${message}`;
            errorElement.innerHTML = errorHTML;

            // ê¸°ì¡´ ë§í¬ ì œê±°
            const existingLink = errorElement.nextElementSibling;
            if (existingLink && existingLink.classList.contains('error-link')) {
                existingLink.remove();
            }

            // ìƒˆ ë§í¬ ì¶”ê°€
            if (linkText && linkUrl) {
                const link = document.createElement('a');
                link.href = linkUrl;
                link.target = '_blank';
                link.className = 'error-link';
                link.textContent = linkText;
                errorElement.parentNode.insertBefore(link, errorElement.nextSibling);
            }
        }

        function getDeribitUrl(ticker) {
            const upperTicker = ticker.toUpperCase();
            return ['BTC', 'ETH', 'SOL'].includes(upperTicker)
                ? `https://www.deribit.com/statistics/${upperTicker}/options`
                : 'https://www.deribit.com/';
        }

        // ì²´ì¸ ì •ë³´ í‘œì‹œ
        function displayChainInfo(platforms, coinId) {
            const chainInfoSection = document.getElementById('chainInfo');
            const chainList = document.getElementById('chainList');

            // ì§€ì› ì²´ì¸ ìˆ˜ì§‘
            let supportedChains = [];

            // ë©”ì´ì € ë„¤ì´í‹°ë¸Œ ì½”ì¸ ì²´í¬
            if (majorNativeCoins[coinId]) {
                const nativeCoin = majorNativeCoins[coinId];
                supportedChains.push({
                    id: nativeCoin.chain,
                    name: nativeCoin.name,
                    icon: nativeCoin.icon,
                    isNative: true,
                    isMajor: true
                });
            }

            // platformsì—ì„œ ì²´ì¸ ì¶”ì¶œ
            if (platforms && Object.keys(platforms).length > 0) {
                Object.keys(platforms).forEach(chain => {
                    // ì´ë¯¸ ë„¤ì´í‹°ë¸Œë¡œ ì¶”ê°€ëœ ê²½ìš° ìŠ¤í‚µ
                    if (majorNativeCoins[coinId] && majorNativeCoins[coinId].chain === chain) {
                        return;
                    }

                    supportedChains.push({
                        id: chain,
                        name: chainNameMap[chain] || chain.charAt(0).toUpperCase() + chain.slice(1).replace(/-/g, ' '),
                        icon: networkIcons[chain],
                        isNative: false,
                        isMajor: majorNetworks.includes(chain)
                    });
                });
            }

            if (supportedChains.length === 0) {
                chainInfoSection.style.display = 'none';
                return;
            }

            // ì •ë ¬: ë„¤ì´í‹°ë¸Œ > ë©”ì´ì € > ê¸°íƒ€
            supportedChains.sort((a, b) => {
                if (a.isNative && !b.isNative) return -1;
                if (!a.isNative && b.isNative) return 1;
                if (a.isMajor && !b.isMajor) return -1;
                if (!a.isMajor && b.isMajor) return 1;
                return 0;
            });

            let chainHTML = '';
            supportedChains.forEach(chain => {
                const icon = chain.icon
                    ? `<img src="${chain.icon}" style="width: 16px; height: 16px; vertical-align: middle; margin-right: 6px;" onerror="this.style.display='none'">`
                    : (chain.isMajor ? 'âœ… ' : 'âšª ');

                chainHTML += `<div class="info-item">${icon}${chain.name}</div>`;
            });

            chainList.innerHTML = chainHTML;
            chainInfoSection.style.display = 'block';
        }

        // ê±°ë˜ì†Œ ì •ë³´ í‘œì‹œ
        function displayExchangeInfo(tickers) {
            const exchangeInfoSection = document.getElementById('exchangeInfo');
            const exchangeList = document.getElementById('exchangeList');

            if (!tickers || tickers.length === 0) {
                exchangeList.innerHTML = '<div class="info-item">ê±°ë˜ì†Œ ì •ë³´ ì—†ìŒ (DEX í™•ì¸ í•„ìš”)</div>';
                exchangeInfoSection.style.display = 'block';
                return;
            }

            // CEX í•„í„°ë§ ë° ê±°ë˜ëŸ‰ ì¶”ì¶œ
            const exchanges = {};
            tickers.forEach(ticker => {
                if (ticker.market && ticker.market.identifier) {
                    const exchangeId = ticker.market.identifier.toLowerCase();
                    if (majorExchanges.includes(exchangeId)) {
                        if (!exchanges[exchangeId]) {
                            exchanges[exchangeId] = {
                                name: exchangeNameMap[exchangeId] || exchangeId,
                                volume: ticker.converted_volume?.usd || 0,
                                isKorean: koreanExchanges.includes(exchangeId)
                            };
                        } else {
                            exchanges[exchangeId].volume += ticker.converted_volume?.usd || 0;
                        }
                    }
                }
            });

            const exchangeArray = Object.entries(exchanges).map(([id, data]) => ({ id, ...data }));

            if (exchangeArray.length === 0) {
                exchangeList.innerHTML = '<div class="info-item">ê±°ë˜ì†Œ ì •ë³´ ì—†ìŒ (DEX í™•ì¸ í•„ìš”)</div>';
                exchangeInfoSection.style.display = 'block';
                return;
            }

            // í•œêµ­ ê±°ë˜ì†Œì™€ ê¸€ë¡œë²Œ ê±°ë˜ì†Œ ë¶„ë¦¬ ë° ì •ë ¬
            const koreanExs = exchangeArray.filter(e => e.isKorean).sort((a, b) => b.volume - a.volume);
            const globalExs = exchangeArray.filter(e => !e.isKorean).sort((a, b) => b.volume - a.volume);

            let exchangeHTML = '';

            // í•œêµ­ ê±°ë˜ì†Œ (ìµœëŒ€ 3ê°œ)
            if (koreanExs.length > 0) {
                const koreanNames = koreanExs.slice(0, 3).map(e => e.name).join(', ');
                exchangeHTML += `<div class="info-item">ğŸ‡°ğŸ‡· ${koreanNames}</div>`;
            }

            // ê¸€ë¡œë²Œ ê±°ë˜ì†Œ (ìµœëŒ€ 5ê°œ)
            if (globalExs.length > 0) {
                const globalNames = globalExs.slice(0, 5).map(e => e.name).join(', ');
                exchangeHTML += `<div class="info-item">ğŸŒ ${globalNames}</div>`;
            }

            exchangeList.innerHTML = exchangeHTML;
            exchangeInfoSection.style.display = 'block';
        }

        // ì§€ê°‘ í˜¸í™˜ì„± í‘œì‹œ
        function displayWalletInfo(platforms, coinId) {
            const walletInfoSection = document.getElementById('walletInfo');
            const walletList = document.getElementById('walletList');

            // ì§€ì› ì²´ì¸ ìˆ˜ì§‘
            let supportedChains = [];

            // ë©”ì´ì € ë„¤ì´í‹°ë¸Œ ì½”ì¸ ì²´í¬
            if (majorNativeCoinsMap[coinId]) {
                supportedChains.push(majorNativeCoinsMap[coinId]);
                console.log('âœ… ë©”ì´ì € ë„¤ì´í‹°ë¸Œ ì½”ì¸ ê°ì§€:', coinId, 'â†’', majorNativeCoinsMap[coinId]);
            }

            // platformsì—ì„œ ì²´ì¸ ì¶”ê°€
            if (platforms && Object.keys(platforms).length > 0) {
                supportedChains.push(...Object.keys(platforms));
            }

            // ì¤‘ë³µ ì œê±°
            supportedChains = [...new Set(supportedChains)];

            console.log('ğŸ”— ì§€ì› ì²´ì¸ ëª©ë¡:', supportedChains);

            if (supportedChains.length === 0) {
                walletInfoSection.style.display = 'none';
                return;
            }

            // Fireblocks ì§€ì› í™•ì¸
            const fireblocksSupported = supportedChains.some(chain =>
                walletSupport.fireblocks.includes(chain)
            );

            // MPC Vault ì§€ì› í™•ì¸
            const mpcVaultSupported = supportedChains.some(chain =>
                walletSupport.mpcVault.includes(chain)
            );

            console.log('ğŸ’¼ ì§€ê°‘ ì§€ì›:', 'Fireblocks:', fireblocksSupported, 'MPC Vault:', mpcVaultSupported);

            let walletHTML = '';

            if (fireblocksSupported) {
                walletHTML += '<div class="info-item">âœ… Fireblocks ì§€ì› ê°€ëŠ¥</div>';
            } else {
                walletHTML += '<div class="info-item">âŒ Fireblocks ë¯¸ì§€ì›</div>';
            }

            if (mpcVaultSupported) {
                walletHTML += '<div class="info-item">âœ… MPC Vault ì§€ì› ê°€ëŠ¥</div>';
            } else {
                walletHTML += '<div class="info-item">âŒ MPC Vault ë¯¸ì§€ì›</div>';
            }

            walletList.innerHTML = walletHTML;
            walletInfoSection.style.display = 'block';
        }

        // ë„ì›€ë§ ëª¨ë‹¬ ì—´ê¸°/ë‹«ê¸°
        function openHelpModal() {
            document.getElementById('helpModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeHelpModal(event) {
            if (!event || event.target === event.currentTarget) {
                document.getElementById('helpModal').classList.remove('active');
                document.body.style.overflow = 'auto';
            }
        }

        // ESC í‚¤ë¡œ ëª¨ë‹¬ ë‹«ê¸°
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeHelpModal();
            }
        });

        // ì´ìŠ¤í„°ì—ê·¸ ì²´í¬ ë° í‘œì‹œ
        function checkEasterEgg(ticker, amount) {
            if (ticker.toLowerCase() === 'patrick lee' && amount === 19941004) {
                // Confetti íš¨ê³¼
                confetti({
                    particleCount: 100,
                    spread: 70,
                    origin: { y: 0.6 }
                });

                // ì´ìŠ¤í„°ì—ê·¸ í‘œì‹œ
                document.getElementById('easterEgg').style.display = 'block';
                document.getElementById('result').style.display = 'none';

                // ìŠ¤í¬ë¡¤ ì´ë™
                setTimeout(() => {
                    document.getElementById('easterEgg').scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 100);

                return true;
            }
            return false;
        }

        // ì‹¤ì‹œê°„ íƒ­ ë¼ë””ì˜¤ ë²„íŠ¼ ë™ì  ìƒì„±
        // ë°ì´í„° ì†ŒìŠ¤ ì˜µì…˜ ì´ˆê¸°í™” (ê³µí†µ)
        function initDataSourceOptions(containerId, sourceName) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';

            dataSources.forEach((source) => {
                const radioOption = document.createElement('div');
                radioOption.className = 'radio-option';

                const radioInput = document.createElement('input');
                radioInput.type = 'radio';
                radioInput.id = `${sourceName}Source${source.id}`;
                radioInput.name = `${sourceName}Source`;
                radioInput.value = source.id;
                radioInput.disabled = !source.enabled;
                if (source.selected) {
                    radioInput.checked = true;
                }

                if (sourceName === 'realtime') {
                    radioInput.addEventListener('change', onRealtimeSourceChange);
                } else {
                    radioInput.addEventListener('change', onHistoricalSourceChange);
                }

                const label = document.createElement('label');
                label.htmlFor = `${sourceName}Source${source.id}`;
                label.textContent = source.name;
                if (!source.enabled) {
                    label.style.color = '#ccc';
                    radioOption.style.cursor = 'not-allowed';
                }

                radioOption.appendChild(radioInput);
                radioOption.appendChild(label);
                container.appendChild(radioOption);
            });
        }

        // ì‹¤ì‹œê°„ íƒ­ ë°ì´í„° ì†ŒìŠ¤ ë³€ê²½ ì´ë²¤íŠ¸
        function onRealtimeSourceChange(event) {
            currentRealtimeSource = event.target.value;
            document.getElementById('coinOptions').style.display = 'none';
            document.getElementById('error').textContent = '';
            selectedCoin = null;
        }

        // ê³¼ê±° íƒ­ ë°ì´í„° ì†ŒìŠ¤ ë³€ê²½ ì´ë²¤íŠ¸
        function onHistoricalSourceChange(event) {
            currentHistoricalSource = event.target.value;
            document.getElementById('histCoinOptions').style.display = 'none';
            document.getElementById('histError').textContent = '';
            histSelectedCoin = null;
        }

        // íƒ­ ì „í™˜
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');

            // ê²°ê³¼ ìˆ¨ê¸°ê¸°
            document.getElementById('result').style.display = 'none';
            document.getElementById('histResult').style.display = 'none';
        }


        // ========== ì‹¤ì‹œê°„ íƒ­ í•¨ìˆ˜ ==========

        function loadSavedCoin() {
            const saved = localStorage.getItem('selectedCoin');
            if (saved) {
                selectedCoin = JSON.parse(saved);
            }
        }

        function saveCoin(coin) {
            localStorage.setItem('selectedCoin', JSON.stringify(coin));
        }

        function formatMarketCap(marketCap) {
            if (marketCap >= 1e9) {
                return '$' + (marketCap / 1e9).toFixed(2) + 'B';
            } else if (marketCap >= 1e6) {
                return '$' + (marketCap / 1e6).toFixed(2) + 'M';
            } else if (marketCap >= 1e3) {
                return '$' + (marketCap / 1e3).toFixed(2) + 'K';
            } else {
                return '$' + marketCap.toFixed(2);
            }
        }

        function formatNumber(num) {
            return new Intl.NumberFormat('ko-KR').format(num);
        }

        function formatVolume(volume) {
            if (volume >= 1e9) {
                return '$' + (volume / 1e9).toFixed(2) + 'B';
            } else if (volume >= 1e6) {
                return '$' + (volume / 1e6).toFixed(2) + 'M';
            } else if (volume >= 1e3) {
                return '$' + (volume / 1e3).toFixed(2) + 'K';
            } else {
                return '$' + volume.toFixed(2);
            }
        }

        async function searchCoin(ticker) {
            const errorElement = document.getElementById('error');
            const selectedSource = document.querySelector('input[name="realtimeSource"]:checked')?.value || 'auto';

            console.log('ğŸ” ê²€ìƒ‰ì–´:', ticker);

            if (!ticker) {
                document.getElementById('coinOptions').style.display = 'none';
                errorElement.textContent = '';
                return;
            }

            // CMC ì„ íƒ ì‹œ ì¤€ë¹„ ì¤‘ ë©”ì‹œì§€
            if (selectedSource === 'coinmarketcap') {
                showError(
                    errorElement,
                    'ğŸš§ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤',
                    'CoinMarketCap API ì—°ë™ì„ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.\nìƒë‹¨ ì™¸ë¶€ ê²€ìƒ‰ì—ì„œ ì§ì ‘ í™•ì¸í•´ì£¼ì„¸ìš”.',
                    'ğŸ”— CoinMarketCapì—ì„œ ì§ì ‘ ê²€ìƒ‰í•˜ê¸°',
                    'https://coinmarketcap.com/'
                );
                document.getElementById('loading').style.display = 'none';
                return;
            }

            // Deribit ì„ íƒ ì‹œ ì¤€ë¹„ ì¤‘ ë©”ì‹œì§€
            if (selectedSource === 'deribit') {
                showError(
                    errorElement,
                    'ğŸš§ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤',
                    'Deribit API ì—°ë™ì„ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.',
                    'ğŸ”— Deribitì—ì„œ ì§ì ‘ í™•ì¸í•˜ê¸°',
                    'https://www.deribit.com/'
                );
                document.getElementById('loading').style.display = 'none';
                return;
            }

            // Auto ë˜ëŠ” CoinGecko â†’ CoinGecko API ì‚¬ìš©

            // ìºì‹œ í™•ì¸
            const cacheKey = ticker.toLowerCase();
            const cacheInfoElement = document.getElementById('cacheInfo');

            if (searchCache[cacheKey] && Date.now() - searchCache[cacheKey].timestamp < CACHE_DURATION) {
                const elapsedMs = Date.now() - searchCache[cacheKey].timestamp;
                const elapsedMin = Math.floor(elapsedMs / 60000);

                let cacheAgeText = '';
                if (elapsedMin < 1) {
                    cacheAgeText = 'ë°©ê¸ˆ ì „';
                } else {
                    cacheAgeText = `${elapsedMin}ë¶„ ì „`;
                }

                console.log('âœ… ìºì‹œ ì‚¬ìš©:', ticker, 'ê²½ê³¼ ì‹œê°„:', elapsedMin, 'ë¶„');
                cacheInfoElement.textContent = `â„¹ï¸ ìºì‹œ (${cacheAgeText})`;
                cacheInfoElement.style.display = 'block';

                displayCoinOptions(searchCache[cacheKey].data);
                document.getElementById('loading').style.display = 'none';
                return;
            }

            // ìƒˆ ì¡°íšŒ - ìºì‹œ ì •ë³´ ìˆ¨ê¹€
            cacheInfoElement.style.display = 'none';

            document.getElementById('loading').style.display = 'block';
            errorElement.innerHTML = '';
            document.getElementById('coinOptions').style.display = 'none';

            // ê¸°ì¡´ ì—ëŸ¬ ë§í¬ ì œê±°
            const existingLink = errorElement.nextElementSibling;
            if (existingLink && existingLink.classList.contains('error-link')) {
                existingLink.remove();
            }

            try {
                const searchUrl = `https://api.coingecko.com/api/v3/search?query=${ticker}`;
                console.log('ğŸ“¡ API í˜¸ì¶œ:', ticker);
                console.log('ğŸ“¡ API URL:', searchUrl);

                const response = await fetch(searchUrl);
                console.log('ğŸ“Š API ìƒíƒœ ì½”ë“œ:', response.status);

                // API ì¿¨íƒ€ì„ ì˜¤ë¥˜ (429)
                if (response.status === 429) {
                    console.log('â³ API ì¿¨íƒ€ì„ ì˜¤ë¥˜ ë°œìƒ');
                    document.getElementById('loading').style.display = 'none';
                    showError(
                        errorElement,
                        'âš ï¸ ê²€ìƒ‰ ì˜¤ë¥˜',
                        'API í˜¸ì¶œì— ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\nìƒë‹¨ ì™¸ë¶€ ê²€ìƒ‰ì—ì„œ CoinMarketCapì„ ì´ìš©í•´ì£¼ì„¸ìš”.',
                        'ğŸ”— CoinMarketCapì—ì„œ ì§ì ‘ ê²€ìƒ‰í•˜ê¸°',
                        'https://coinmarketcap.com/'
                    );
                    return;
                }

                // ì„œë²„ ì˜¤ë¥˜ (500ë²ˆëŒ€)
                if (response.status >= 500) {
                    console.log('âš ï¸ ì„œë²„ ì˜¤ë¥˜ ë°œìƒ:', response.status);
                    document.getElementById('loading').style.display = 'none';
                    showError(
                        errorElement,
                        'âš ï¸ ê²€ìƒ‰ ì˜¤ë¥˜',
                        'API í˜¸ì¶œì— ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\nìƒë‹¨ ì™¸ë¶€ ê²€ìƒ‰ì—ì„œ CoinMarketCapì„ ì´ìš©í•´ì£¼ì„¸ìš”.',
                        'ğŸ”— CoinMarketCapì—ì„œ ì§ì ‘ ê²€ìƒ‰í•˜ê¸°',
                        'https://coinmarketcap.com/'
                    );
                    return;
                }

                // 404 ë˜ëŠ” ê¸°íƒ€ ì˜¤ë¥˜
                if (!response.ok) {
                    console.log('âŒ HTTP ì˜¤ë¥˜:', response.status, response.statusText);
                    document.getElementById('loading').style.display = 'none';
                    showError(
                        errorElement,
                        'âš ï¸ ê²€ìƒ‰ ì˜¤ë¥˜',
                        'API í˜¸ì¶œì— ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\nìƒë‹¨ ì™¸ë¶€ ê²€ìƒ‰ì—ì„œ CoinMarketCapì„ ì´ìš©í•´ì£¼ì„¸ìš”.',
                        'ğŸ”— CoinMarketCapì—ì„œ ì§ì ‘ ê²€ìƒ‰í•˜ê¸°',
                        'https://coinmarketcap.com/'
                    );
                    return;
                }

                const data = await response.json();
                console.log('ğŸ“Š ê²€ìƒ‰ ê²°ê³¼ ê°œìˆ˜:', data.coins ? data.coins.length : 0);

                if (data.coins && data.coins.length > 0) {
                    console.log('âœ… ì „ì²´ ê²€ìƒ‰ ê²°ê³¼:', data.coins.length, 'ê°œ');

                    const searchTicker = ticker.toLowerCase();

                    // 1ë‹¨ê³„: ì •í™• ì¼ì¹˜
                    const exactMatch = data.coins.filter(coin =>
                        coin.symbol.toLowerCase() === searchTicker
                    );

                    // 2ë‹¨ê³„: ì‹œì‘ ì¼ì¹˜
                    const startsMatch = data.coins.filter(coin =>
                        coin.symbol.toLowerCase().startsWith(searchTicker) &&
                        coin.symbol.toLowerCase() !== searchTicker
                    );

                    // 3ë‹¨ê³„: í¬í•¨
                    const containsMatch = data.coins.filter(coin =>
                        coin.symbol.toLowerCase().includes(searchTicker) &&
                        !coin.symbol.toLowerCase().startsWith(searchTicker)
                    );

                    // ê° ê·¸ë£¹ ë‚´ì—ì„œ market_cap_rank ê¸°ì¤€ ì •ë ¬ (ìˆ«ì ë‚®ì„ìˆ˜ë¡ ìš°ì„ )
                    const sortByRank = (a, b) => {
                        const rankA = a.market_cap_rank || 99999;
                        const rankB = b.market_cap_rank || 99999;
                        return rankA - rankB;
                    };

                    exactMatch.sort(sortByRank);
                    startsMatch.sort(sortByRank);
                    containsMatch.sort(sortByRank);

                    // í•©ì¹˜ê¸°: ì •í™• ì¼ì¹˜ â†’ ì‹œì‘ ì¼ì¹˜ â†’ í¬í•¨
                    const prioritizedCoins = [...exactMatch, ...startsMatch, ...containsMatch];

                    console.log('ğŸ“Š ì •ë ¬ ê²°ê³¼ - ì •í™•:', exactMatch.length, 'ì‹œì‘:', startsMatch.length, 'í¬í•¨:', containsMatch.length);

                    // ìƒìœ„ 10ê°œë§Œ ì„ íƒ
                    const topCoins = prioritizedCoins.slice(0, 10);

                    const coinDetails = await Promise.all(
                        topCoins.map(async (coin) => {
                            try {
                                const detailResponse = await fetch(`https://api.coingecko.com/api/v3/coins/${coin.id}`);
                                const detail = await detailResponse.json();
                                return {
                                    id: coin.id,
                                    symbol: coin.symbol,
                                    name: coin.name,
                                    marketCap: detail.market_data?.market_cap?.usd || 0,
                                    currentPrice: detail.market_data?.current_price?.usd || 0,
                                    volume24h: detail.market_data?.total_volume?.usd || 0,
                                    thumb: coin.thumb,
                                    platforms: detail.platforms || {},
                                    tickers: detail.tickers || []
                                };
                            } catch (e) {
                                console.error('âŒ ì½”ì¸ ìƒì„¸ ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨:', coin.id, e);
                                return null;
                            }
                        })
                    );

                    const validCoins = coinDetails.filter(c => c !== null);

                    if (validCoins.length === 0) {
                        document.getElementById('loading').style.display = 'none';
                        showError(
                            errorElement,
                            'âš ï¸ ê°€ê²© ì •ë³´ ì—†ìŒ',
                            `"${ticker}" ì½”ì¸ì˜ ê°€ê²© ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`
                        );
                        return;
                    }

                    // ì‹œê°€ì´ì•¡ ìˆœ ì •ë ¬ (ë‚´ë¦¼ì°¨ìˆœ) - validCoins ì •ë ¬
                    const sortedCoins = validCoins.sort((a, b) => b.marketCap - a.marketCap);
                    console.log('ğŸ“Š ì‹œê°€ì´ì•¡ ìˆœ ì •ë ¬ ì™„ë£Œ:', sortedCoins.length, 'ê°œ');

                    // ìºì‹œì— ì €ì¥
                    searchCache[cacheKey] = {
                        data: sortedCoins,
                        timestamp: Date.now()
                    };
                    console.log('ğŸ’¾ ìºì‹œ ì €ì¥:', ticker);

                    // ì‹¤ì‹œê°„ ì¡°íšŒ í‘œì‹œ
                    const cacheInfoElement = document.getElementById('cacheInfo');
                    cacheInfoElement.textContent = 'ğŸ”„ ì‹¤ì‹œê°„';
                    cacheInfoElement.style.display = 'block';

                    displayCoinOptions(sortedCoins);
                } else {
                    // ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ì„ ë•Œë„ renamedTickers ì²´í¬
                    const upperTicker = ticker.toUpperCase();
                    console.log('ğŸ”„ renamedTickers í™•ì¸ (ê²°ê³¼ ì—†ìŒ):', upperTicker, renamedTickers[upperTicker]);

                    if (renamedTickers[upperTicker]) {
                        const renamed = renamedTickers[upperTicker];
                        console.log('ğŸ¯ ë³€ê²½ëœ í‹°ì»¤ ë°œê²¬:', renamed);

                        // ë³€ê²½ëœ í‹°ì»¤ë¡œ ì§ì ‘ ì¡°íšŒ
                        try {
                            const directUrl = `https://api.coingecko.com/api/v3/coins/${renamed.apiId}`;
                            console.log('ğŸ“¡ ì§ì ‘ ì¡°íšŒ URL:', directUrl);

                            const directResponse = await fetch(directUrl);
                            const coinData = await directResponse.json();

                            if (coinData && coinData.id) {
                                console.log('âœ… ì§ì ‘ ì¡°íšŒ ì„±ê³µ:', coinData.name);

                                const renamedCoin = {
                                    id: coinData.id,
                                    symbol: coinData.symbol,
                                    name: coinData.name,
                                    marketCap: coinData.market_data?.market_cap?.usd || 0,
                                    currentPrice: coinData.market_data?.current_price?.usd || 0,
                                    volume24h: coinData.market_data?.total_volume?.usd || 0,
                                    thumb: coinData.image?.thumb,
                                    platforms: coinData.platforms || {},
                                    tickers: coinData.tickers || []
                                };

                                // ì•ˆë‚´ ë©”ì‹œì§€ í‘œì‹œ
                                showError(
                                    errorElement,
                                    'â„¹ï¸ í‹°ì»¤ ë³€ê²½ ì•ˆë‚´',
                                    `"${renamed.oldName}"ëŠ” "${renamed.newName}"ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.`
                                );

                                displayCoinOptions([renamedCoin]);
                                document.getElementById('loading').style.display = 'none';
                                return;
                            }
                        } catch (e) {
                            console.error('âŒ ì§ì ‘ ì¡°íšŒ ì‹¤íŒ¨:', e);
                        }
                    }

                    showError(
                        errorElement,
                        'âŒ ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ',
                        `"${ticker}"ì— í•´ë‹¹í•˜ëŠ” ì½”ì¸ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\ní‹°ì»¤ ë˜ëŠ” ì´ë¦„ì„ í™•ì¸í•´ì£¼ì„¸ìš”.`,
                        'ğŸ”— CoinMarketCapì—ì„œ ì§ì ‘ ê²€ìƒ‰í•˜ê¸°',
                        'https://coinmarketcap.com/'
                    );
                }
            } catch (error) {
                console.error('âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜:', error);
                showError(
                    errorElement,
                    'âš ï¸ ë„¤íŠ¸ì›Œí¬ ì—°ê²° ì˜¤ë¥˜',
                    'ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.\nìƒë‹¨ ì™¸ë¶€ ê²€ìƒ‰ì—ì„œ CoinMarketCapì„ ì´ìš©í•´ì£¼ì„¸ìš”.',
                    'ğŸ”— CoinMarketCapì—ì„œ ì§ì ‘ ê²€ìƒ‰í•˜ê¸°',
                    'https://coinmarketcap.com/'
                );
            }

            document.getElementById('loading').style.display = 'none';
        }


        function displayCoinOptions(coins) {
            const container = document.getElementById('coinOptions');
            container.innerHTML = '';
            container.style.display = 'block';

            coins.forEach((coin, index) => {
                const option = document.createElement('div');
                option.className = 'coin-option';
                if (index === 0) {
                    option.classList.add('selected');
                    selectedCoin = coin;
                    saveCoin(coin);
                }

                option.innerHTML = `
                    <div class="coin-name">
                        ${coin.name} <span class="coin-ticker">(${coin.symbol.toUpperCase()})</span>
                        ${index === 0 ? '<span class="rank-badge">ì‹œì´ 1ìœ„</span>' : ''}
                    </div>
                    <div class="coin-market-cap">
                        <span class="coin-price">$${formatNumber(coin.currentPrice)}</span> | ì‹œì´: ${formatMarketCap(coin.marketCap)}
                    </div>
                    <div class="coin-volume">
                        24h ê±°ë˜ëŸ‰: ${formatVolume(coin.volume24h)}
                    </div>
                `;

                option.addEventListener('click', () => {
                    document.querySelectorAll('.coin-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    option.classList.add('selected');
                    selectedCoin = coin;
                    saveCoin(coin);
                    calculate();
                });

                container.appendChild(option);
            });

            calculate();
        }

        async function getUsdtKrwRate() {
            try {
                const response = await fetch('https://api.upbit.com/v1/ticker?markets=KRW-USDT');
                const data = await response.json();
                if (data && data[0]) {
                    usdtKrwRate = data[0].trade_price;
                }
            } catch (error) {
                console.error('í™˜ìœ¨ ì¡°íšŒ ì˜¤ë¥˜:', error);
            }
        }

        function formatAmountInput(input) {
            let cursorPosition = input.selectionStart;
            const oldValue = input.value;
            const oldLength = oldValue.length;

            let value = input.value.replace(/[^\d.]/g, '');

            const parts = value.split('.');
            if (parts.length > 2) {
                value = parts[0] + '.' + parts.slice(1).join('');
            }

            if (value === '') {
                input.value = '';
                return;
            }

            const [integerPart, decimalPart] = value.split('.');
            const formattedInteger = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            const formattedValue = decimalPart !== undefined
                ? formattedInteger + '.' + decimalPart
                : formattedInteger;

            input.value = formattedValue;

            const newLength = formattedValue.length;
            const diff = newLength - oldLength;
            input.setSelectionRange(cursorPosition + diff, cursorPosition + diff);
        }

        function parseAmount(formattedValue) {
            return parseFloat(formattedValue.replace(/,/g, ''));
        }

        async function calculate() {
            const amountInput = document.getElementById('amount').value;
            const amount = parseAmount(amountInput);

            if (!selectedCoin || !amount || amount <= 0 || isNaN(amount)) {
                document.getElementById('result').style.display = 'none';
                return;
            }

            await getUsdtKrwRate();

            const usdtTotal = selectedCoin.currentPrice * amount;
            const krwTotal = usdtTotal * usdtKrwRate;

            document.getElementById('usdtTotal').textContent = '$' + formatNumber(usdtTotal.toFixed(2));
            document.getElementById('krwTotal').textContent = 'â‚©' + formatNumber(Math.round(krwTotal));
            document.getElementById('coinPrice').textContent = `1 ${selectedCoin.symbol.toUpperCase()} = $${formatNumber(selectedCoin.currentPrice)}`;
            document.getElementById('exchangeRate').textContent = `USDT/KRW: â‚©${formatNumber(usdtKrwRate.toFixed(2))}`;

            // ë°ì´í„° ì†ŒìŠ¤ í‘œì‹œ
            const selectedSource = document.querySelector('input[name="realtimeSource"]:checked')?.value || 'auto';
            const sourceDisplay = selectedSource === 'auto' ? 'CoinGecko' : 'CoinGecko';
            document.getElementById('coinPriceSource').textContent = `* ê¸°ì¤€: ${sourceDisplay}`;

            // ì²´ì¸, ê±°ë˜ì†Œ, ì§€ê°‘ ì •ë³´ í‘œì‹œ
            displayChainInfo(selectedCoin.platforms, selectedCoin.id);
            displayExchangeInfo(selectedCoin.tickers);
            displayWalletInfo(selectedCoin.platforms, selectedCoin.id);

            // ë§í¬ ìë™ ë³€ê²½
            const link = document.getElementById('coingeckoLink');
            if (selectedSource === 'coinmarketcap') {
                link.href = `https://coinmarketcap.com/currencies/${selectedCoin.id}/`;
                link.textContent = 'ğŸ”— CoinMarketCapì—ì„œ í™•ì¸í•˜ê¸°';
            } else {
                // Auto ë˜ëŠ” CoinGecko
                link.href = `https://www.coingecko.com/en/coins/${selectedCoin.id}`;
                link.textContent = 'ğŸ”— CoinGeckoì—ì„œ í™•ì¸í•˜ê¸°';
            }
            link.style.display = 'inline-block';

            document.getElementById('result').style.display = 'block';
        }

        // ========== ê³¼ê±° ì¡°íšŒ íƒ­ í•¨ìˆ˜ ==========

        async function searchHistoricalCoin(ticker) {
            const errorElement = document.getElementById('histError');

            if (!ticker) {
                document.getElementById('histCoinOptions').style.display = 'none';
                errorElement.textContent = '';
                return;
            }

            document.getElementById('histLoading').style.display = 'block';
            errorElement.innerHTML = '';
            document.getElementById('histCoinOptions').style.display = 'none';

            // ê¸°ì¡´ ì—ëŸ¬ ë§í¬ ì œê±°
            const existingLink = errorElement.nextElementSibling;
            if (existingLink && existingLink.classList.contains('error-link')) {
                existingLink.remove();
            }

            try {
                const response = await fetch(`https://api.coingecko.com/api/v3/search?query=${ticker}`);

                // API ì¿¨íƒ€ì„ ì˜¤ë¥˜ (429)
                if (response.status === 429) {
                    document.getElementById('histLoading').style.display = 'none';
                    showError(
                        errorElement,
                        'âš ï¸ ê²€ìƒ‰ ì˜¤ë¥˜',
                        'API í˜¸ì¶œì— ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\nìƒë‹¨ ì™¸ë¶€ ê²€ìƒ‰ì—ì„œ CoinMarketCapì„ ì´ìš©í•´ì£¼ì„¸ìš”.',
                        'ğŸ”— CoinMarketCapì—ì„œ ì§ì ‘ ê²€ìƒ‰í•˜ê¸°',
                        'https://coinmarketcap.com/'
                    );
                    return;
                }

                // ì„œë²„ ì˜¤ë¥˜ (500ë²ˆëŒ€)
                if (response.status >= 500) {
                    document.getElementById('histLoading').style.display = 'none';
                    showError(
                        errorElement,
                        'âš ï¸ ê²€ìƒ‰ ì˜¤ë¥˜',
                        'API í˜¸ì¶œì— ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\nìƒë‹¨ ì™¸ë¶€ ê²€ìƒ‰ì—ì„œ CoinMarketCapì„ ì´ìš©í•´ì£¼ì„¸ìš”.',
                        'ğŸ”— CoinMarketCapì—ì„œ ì§ì ‘ ê²€ìƒ‰í•˜ê¸°',
                        'https://coinmarketcap.com/'
                    );
                    return;
                }

                const data = await response.json();

                if (data.coins && data.coins.length > 0) {
                    const matchingCoins = data.coins.filter(coin =>
                        coin.symbol.toLowerCase() === ticker.toLowerCase()
                    );

                    if (matchingCoins.length === 0) {
                        document.getElementById('histLoading').style.display = 'none';
                        showError(
                            errorElement,
                            'âŒ ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ',
                            `"${ticker}"ì— í•´ë‹¹í•˜ëŠ” ì½”ì¸ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\ní‹°ì»¤ ë˜ëŠ” ì´ë¦„ì„ í™•ì¸í•´ì£¼ì„¸ìš”.`,
                            'ğŸ”— CoinMarketCapì—ì„œ ì§ì ‘ ê²€ìƒ‰í•˜ê¸°',
                            'https://coinmarketcap.com/'
                        );
                        return;
                    }

                    const coinDetails = await Promise.all(
                        matchingCoins.slice(0, 10).map(async (coin) => {
                            try {
                                const detailResponse = await fetch(`https://api.coingecko.com/api/v3/coins/${coin.id}`);
                                const detail = await detailResponse.json();
                                return {
                                    id: coin.id,
                                    symbol: coin.symbol,
                                    name: coin.name,
                                    marketCap: detail.market_data?.market_cap?.usd || 0,
                                    thumb: coin.thumb
                                };
                            } catch (e) {
                                return null;
                            }
                        })
                    );

                    const validCoins = coinDetails.filter(c => c !== null)
                        .sort((a, b) => b.marketCap - a.marketCap);

                    if (validCoins.length === 0) {
                        document.getElementById('histLoading').style.display = 'none';
                        showError(
                            errorElement,
                            'âš ï¸ ê°€ê²© ì •ë³´ ì—†ìŒ',
                            `"${ticker}" ì½”ì¸ì˜ ê°€ê²© ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`
                        );
                        return;
                    }

                    displayHistoricalCoinOptions(validCoins);
                } else {
                    showError(
                        errorElement,
                        'âŒ ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ',
                        `"${ticker}"ì— í•´ë‹¹í•˜ëŠ” ì½”ì¸ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\ní‹°ì»¤ ë˜ëŠ” ì´ë¦„ì„ í™•ì¸í•´ì£¼ì„¸ìš”.`,
                        'ğŸ”— CoinMarketCapì—ì„œ ì§ì ‘ ê²€ìƒ‰í•˜ê¸°',
                        'https://coinmarketcap.com/'
                    );
                }
            } catch (error) {
                console.error(error);
                showError(
                    errorElement,
                    'âš ï¸ ë„¤íŠ¸ì›Œí¬ ì—°ê²° ì˜¤ë¥˜',
                    'ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.\nìƒë‹¨ ì™¸ë¶€ ê²€ìƒ‰ì—ì„œ CoinMarketCapì„ ì´ìš©í•´ì£¼ì„¸ìš”.',
                    'ğŸ”— CoinMarketCapì—ì„œ ì§ì ‘ ê²€ìƒ‰í•˜ê¸°',
                    'https://coinmarketcap.com/'
                );
            }

            document.getElementById('histLoading').style.display = 'none';
        }

        function displayHistoricalCoinOptions(coins) {
            const container = document.getElementById('histCoinOptions');
            container.innerHTML = '';
            container.style.display = 'block';

            coins.forEach((coin, index) => {
                const option = document.createElement('div');
                option.className = 'coin-option';
                if (index === 0) {
                    option.classList.add('selected');
                    histSelectedCoin = coin;
                }

                option.innerHTML = `
                    <div class="coin-name">
                        ${coin.name} <span class="coin-ticker">(${coin.symbol.toUpperCase()})</span>
                        ${index === 0 ? '<span class="rank-badge">ì‹œì´ 1ìœ„</span>' : ''}
                    </div>
                    <div class="coin-market-cap">
                        ì‹œì´: ${formatMarketCap(coin.marketCap)}
                    </div>
                `;

                option.addEventListener('click', () => {
                    document.querySelectorAll('#histCoinOptions .coin-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    option.classList.add('selected');
                    histSelectedCoin = coin;
                    calculateHistorical();
                });

                container.appendChild(option);
            });

            calculateHistorical();
        }

        async function getHistoricalPriceFromCoinGecko(coinId, date) {
            try {
                const response = await fetch(
                    `https://api.coingecko.com/api/v3/coins/${coinId}/history?date=${date}`
                );
                const data = await response.json();
                return data.market_data?.current_price?.usd || null;
            } catch (error) {
                console.error('CoinGecko ê³¼ê±° ê°€ê²© ì¡°íšŒ ì˜¤ë¥˜:', error);
                return null;
            }
        }

        async function getHistoricalPriceFromDeribit(currency, timestamp) {
            try {
                // Deribit APIë¥¼ ì‚¬ìš©í•˜ì—¬ íŠ¹ì • ë‚ ì§œì˜ Index ì¢…ê°€ ì¡°íšŒ
                const response = await fetch(
                    `https://www.deribit.com/api/v2/public/get_tradingview_chart_data?instrument_name=${currency}_usd&start_timestamp=${timestamp}&end_timestamp=${timestamp + 86400000}&resolution=1D`
                );
                const data = await response.json();

                if (data.result && data.result.close && data.result.close.length > 0) {
                    return data.result.close[0];
                }
                return null;
            } catch (error) {
                console.error('Deribit ê³¼ê±° ê°€ê²© ì¡°íšŒ ì˜¤ë¥˜:', error);
                return null;
            }
        }

        async function getUsdKrwRate(date) {
            // ì‹¤ì œë¡œëŠ” ê³¼ê±° USD/KRW í™˜ìœ¨ APIë¥¼ ì‚¬ìš©í•´ì•¼ í•˜ì§€ë§Œ,
            // ì—¬ê¸°ì„œëŠ” exchangerate-api.comì„ ì‚¬ìš© (ë¬´ë£Œ, ê³¼ê±° ë°ì´í„° ì œí•œì )
            try {
                const response = await fetch(`https://api.exchangerate-api.com/v4/latest/USD`);
                const data = await response.json();
                return data.rates.KRW || 1300; // ê¸°ë³¸ê°’
            } catch (error) {
                console.error('USD/KRW í™˜ìœ¨ ì¡°íšŒ ì˜¤ë¥˜:', error);
                return 1300; // ê¸°ë³¸ê°’
            }
        }

        async function calculateHistorical() {
            const date = document.getElementById('histDate').value;
            const amountInput = document.getElementById('histAmount').value;
            const amount = parseAmount(amountInput);
            const isDeribit = document.getElementById('sourceDeribit').checked;

            if (!date || !amount || amount <= 0 || isNaN(amount)) {
                document.getElementById('histResult').style.display = 'none';
                return;
            }

            if (isDeribit) {
                const currency = document.getElementById('histCoinSelect').value;
                await calculateDeribitHistorical(currency, date, amount);
            } else {
                if (!histSelectedCoin) {
                    document.getElementById('histResult').style.display = 'none';
                    return;
                }
                await calculateCoinGeckoHistorical(histSelectedCoin, date, amount);
            }
        }

        async function calculateCoinGeckoHistorical(coin, dateStr, amount) {
            const [year, month, day] = dateStr.split('-');
            const formattedDate = `${day}-${month}-${year}`;

            const price = await getHistoricalPriceFromCoinGecko(coin.id, formattedDate);

            if (!price) {
                const errorElement = document.getElementById('histError');
                showError(
                    errorElement,
                    'âš ï¸ ê°€ê²© ì •ë³´ ì—†ìŒ',
                    'í•´ë‹¹ ë‚ ì§œì˜ ê°€ê²© ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'
                );
                return;
            }

            await getUsdtKrwRate();

            const usdtTotal = price * amount;
            const krwTotal = usdtTotal * usdtKrwRate;

            document.getElementById('histResultDate').textContent = `${dateStr} ê¸°ì¤€ (ì¼í‰ê·  ê°€ê²©)`;
            document.getElementById('histUsdLabel').textContent = 'USDT ì´ì•¡';
            document.getElementById('histUsdtTotal').textContent = '$' + formatNumber(usdtTotal.toFixed(2));
            document.getElementById('histKrwTotal').textContent = 'â‚©' + formatNumber(Math.round(krwTotal));
            document.getElementById('histCoinPrice').textContent = `1 ${coin.symbol.toUpperCase()} = $${formatNumber(price)}`;
            document.getElementById('histCoinPriceSource').textContent = '* ê¸°ì¤€: CoinGecko';
            document.getElementById('histExchangeRate').textContent = `USDT/KRW: â‚©${formatNumber(usdtKrwRate.toFixed(2))}`;

            const link = document.getElementById('histLink');
            link.href = `https://www.coingecko.com/en/coins/${coin.id}`;
            link.style.display = 'inline-block';
            link.textContent = 'ğŸ”— CoinGeckoì—ì„œ í™•ì¸í•˜ê¸°';

            document.getElementById('histError').textContent = '';
            document.getElementById('histResult').style.display = 'block';
        }

        async function calculateDeribitHistorical(currency, dateStr, amount) {
            const errorElement = document.getElementById('histError');

            // Deribit APIëŠ” í˜„ì¬ ì‚¬ìš© ë¶ˆê°€ ë©”ì‹œì§€ í‘œì‹œ
            showError(
                errorElement,
                'âš ï¸ APIë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤',
                'Deribit IndexëŠ” í˜„ì¬ APIë¥¼ ì œê³µí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.\n(ì´ í”„ë¡œì íŠ¸ëŠ” ìƒ˜í”Œë¡œ, ë°ì´í„° ì†ŒìŠ¤ í™•ì¥ ê°€ëŠ¥ì„±ì„ ë³´ì—¬ì¤ë‹ˆë‹¤)',
                'ğŸ”— Deribitì—ì„œ ì§ì ‘ í™•ì¸í•˜ê¸°',
                getDeribitUrl(currency)
            );
            return;

            // ì•„ë˜ ì½”ë“œëŠ” ì‹¤ì œ APIê°€ ì œê³µë  ë•Œ ì‚¬ìš©
            /*
            const timestamp = new Date(dateStr + 'T00:00:00Z').getTime();
            const price = await getHistoricalPriceFromDeribit(currency, timestamp);

            if (!price) {
                showError(
                    errorElement,
                    'âš ï¸ ê°€ê²© ì •ë³´ ì—†ìŒ',
                    'í•´ë‹¹ ë‚ ì§œì˜ ê°€ê²© ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'
                );
                return;
            }

            const usdKrwRate = await getUsdKrwRate(dateStr);

            const usdTotal = price * amount;
            const krwTotal = usdTotal * usdKrwRate;

            const koreaDate = new Date(timestamp + (9 * 60 * 60 * 1000));
            document.getElementById('histResultDate').textContent =
                `${dateStr} UTC 00:00 ì¢…ê°€ ê¸°ì¤€ (í•œêµ­ì‹œê°„ ${koreaDate.toLocaleString('ko-KR', {hour: '2-digit', minute: '2-digit'})})`;
            document.getElementById('histUsdLabel').textContent = 'USD ì´ì•¡';
            document.getElementById('histUsdtTotal').textContent = '$' + formatNumber(usdTotal.toFixed(2));
            document.getElementById('histKrwTotal').textContent = 'â‚©' + formatNumber(Math.round(krwTotal));
            document.getElementById('histCoinPrice').textContent = `1 ${currency} = $${formatNumber(price)} (ì¢…ê°€)`;
            document.getElementById('histCoinPriceSource').textContent = '* ê¸°ì¤€: Deribit Index';
            document.getElementById('histExchangeRate').textContent = `USD/KRW: â‚©${formatNumber(usdKrwRate.toFixed(2))}`;

            const link = document.getElementById('histLink');
            link.href = getDeribitUrl(currency);
            link.style.display = 'inline-block';
            link.textContent = 'ğŸ”— Deribitì—ì„œ í™•ì¸í•˜ê¸°';

            document.getElementById('histError').textContent = '';
            document.getElementById('histResult').style.display = 'block';
            */
        }

        // ========== ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ==========

        // ì‹¤ì‹œê°„ íƒ­
        document.getElementById('ticker').addEventListener('input', (e) => {
            const ticker = e.target.value.trim();

            // ì´ìŠ¤í„°ì—ê·¸ ìˆ¨ê¸°ê¸°
            document.getElementById('easterEgg').style.display = 'none';

            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                searchCoin(ticker);
            }, 500);
        });

        const amountInput = document.getElementById('amount');
        amountInput.addEventListener('input', (e) => {
            formatAmountInput(e.target);

            // ì´ìŠ¤í„°ì—ê·¸ ì²´í¬
            const ticker = document.getElementById('ticker').value.trim();
            const amount = parseAmount(e.target.value);

            if (checkEasterEgg(ticker, amount)) {
                return;
            }

            calculate();
        });

        // ê³¼ê±° ì¡°íšŒ íƒ­
        document.getElementById('histTicker').addEventListener('input', (e) => {
            clearTimeout(histDebounceTimer);
            histDebounceTimer = setTimeout(() => {
                searchHistoricalCoin(e.target.value.trim());
            }, 500);
        });

        const histAmountInput = document.getElementById('histAmount');
        histAmountInput.addEventListener('input', (e) => {
            formatAmountInput(e.target);
            calculateHistorical();
        });

        document.getElementById('histDate').addEventListener('change', calculateHistorical);

        // ì´ˆê¸°í™”
        initDataSourceOptions('realtimeSourceOptions', 'realtime');
        initDataSourceOptions('historicalSourceOptions', 'historical');
        loadSavedCoin();
        getUsdtKrwRate();

        // ì˜¤ëŠ˜ ë‚ ì§œë¥¼ ê¸°ë³¸ê°’ìœ¼ë¡œ ì„¤ì •
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('histDate').value = today;
    </script>
</body>
</html>
